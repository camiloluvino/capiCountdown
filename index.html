<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador Capibara</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Outfit:wght@300;400;600&display=swap');

        :root {
            --bg-color: #FDFCF5;
            --bg-gradient: linear-gradient(to bottom, #FDFCF5, #F4F1EA);
            --text-color: #5D5D5D;
            --bamboo-color: #8FBC8F;
            --bamboo-shadow: #556B2F;
            --accent-color: #E6A57E;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.4);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.5s;
        }

        body.night-mode {
            --bg-color: #1a1a2e;
            --bg-gradient: none;
            /* Fix: Remove day gradient in night mode */
            --text-color: #e0e0e0;
            --bamboo-color: #2e4a2e;
            --bamboo-shadow: #1a2e1a;
            --glass-bg: rgba(30, 30, 46, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            text-align: center;
            overflow-x: hidden;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            font-weight: 300;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text-color);
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: 1.1rem;
            margin-bottom: 50px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .capybara-container {
            margin-top: 20px;
            /* Add space from subtitle */
            margin-bottom: 20px;
            position: relative;
            width: 250px;
            /* Increased to 250px */
            height: 250px;
            /* Increased to 250px */
            display: flex;
            justify-content: center;
            align-items: center;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.08));
            /* Restored shadow size */
        }

        .capybara-img {
            width: 250px;
            height: auto;
            max-width: 100%;
            transition: transform 0.3s ease, opacity 0.5s ease;
            cursor: pointer;
        }


        .counter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            max-width: 800px;
            min-height: 100px;
            margin-top: 40px;
        }

        /* Bamboo Bundle Styles */
        .bundle {
            position: relative;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: space-between;
            padding: 5px;
        }

        .stick {
            width: 6px;
            height: 100%;
            background: linear-gradient(to right, var(--bamboo-color), #A2D5A2);
            border-radius: 3px;
            position: relative;
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.5s ease;
        }

        /* Bamboo segments */
        .stick::before,
        .stick::after {
            content: '';
            position: absolute;
            left: -1px;
            right: -1px;
            height: 1px;
            background-color: var(--bamboo-shadow);
            opacity: 0.3;
        }

        .stick::before {
            top: 30%;
        }

        .stick::after {
            top: 70%;
        }

        /* The 5th stick (diagonal) */
        .stick.diagonal {
            position: absolute;
            top: 50%;
            left: 50%;
            height: 6px;
            width: 120%;
            transform: translate(-50%, -50%) rotate(-45deg);
            z-index: 2;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .bundle.completed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #C19A6B;
            transform: translateY(-50%);
            z-index: 1;
            border-radius: 2px;
        }

        .days-left-text {
            margin-top: 50px;
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--bamboo-shadow);
            opacity: 0.8;
        }

        .yuzu {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background-color: #FFD700;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none;
        }

        .bundle.completed .yuzu {
            display: block;
        }

        .yuzu::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 50%;
            width: 4px;
            height: 2px;
            background-color: #556B2F;
            transform: translateX(-50%);
        }

        /* Animations */
        @keyframes fallAndFade {
            0% {
                transform: translateY(0) rotate(0);
                opacity: 1;
            }

            100% {
                transform: translateY(50px) rotate(20deg);
                opacity: 0;
            }
        }

        .stick.falling {
            animation: fallAndFade 1s forwards;
        }

        /* Debug / Time Travel UI */
        .debug-panel {
            margin-top: 80px;
            padding: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 400px;
            text-align: center;
            display: none;
            /* Hidden by default */
        }

        .debug-panel summary {
            cursor: pointer;
            color: #ccc;
            font-size: 0.8rem;
            list-style: none;
        }

        .slider-container {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
        }

        /* Falling Leaves Animation */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FDFCF5;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease;
            pointer-events: none;
        }

        .leaf {
            position: absolute;
            top: -50px;
            width: 20px;
            height: 20px;
            background-color: #8FBC8F;
            border-radius: 0 50% 0 50%;
            opacity: 0.8;
            animation: drop 3s linear forwards;
        }

        @keyframes drop {
            0% {
                transform: translateY(0) rotate(0deg) translateX(0);
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                transform: translateY(110vh) rotate(360deg) translateX(20px);
                opacity: 0;
            }
        }

        /* Petting Animation */
        .heart {
            position: absolute;
            font-size: 24px;
            pointer-events: none;
            animation: floatUpAndFade 1s ease-out forwards;
            z-index: 20;
        }

        @keyframes floatUpAndFade {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-50px) scale(1.5);
                opacity: 0;
            }
        }

        .capybara-img.petting {
            animation: wiggle 0.3s ease-in-out;
        }

        @keyframes wiggle {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.95) rotate(-2deg);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Happy Bounce Animation */
        @keyframes happyBounce {
            0% {
                transform: scale(1) translateY(0);
            }

            25% {
                transform: scale(1.1) translateY(-10px);
            }

            50% {
                transform: scale(1) translateY(0);
            }

            75% {
                transform: scale(1.1) translateY(-5px);
            }

            100% {
                transform: scale(1) translateY(0);
            }
        }

        .capybara-img.happy-bounce {
            animation: happyBounce 0.6s ease-in-out;
        }

        .text-bubble {
            position: absolute;
            background: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            border: 1px solid var(--bamboo-color);
            color: var(--bamboo-shadow);
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .text-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: var(--bamboo-color) transparent transparent transparent;
        }

        /* Message of the Day */
        .message-box {
            margin-top: 30px;
            padding: 20px 40px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            font-family: 'Lora', serif;
            font-style: italic;
            color: var(--text-color);
            max-width: 600px;
            font-size: 1.2rem;
            line-height: 1.6;
            position: relative;
            transition: opacity 0.5s ease, background-color var(--transition-speed), color var(--transition-speed);
        }

        body.night-mode .message-box {
            background-color: rgba(42, 42, 62, 0.4);
            color: #a2d5a2;
        }

        .message-box::after {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent var(--glass-bg) transparent;
            transition: border-color var(--transition-speed);
        }

        body.night-mode .message-box::after {
            border-color: transparent transparent rgba(42, 42, 62, 0.4) transparent;
        }

        /* Feeding Menu */
        .feeding-menu {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: var(--shadow-soft);
            display: flex;
            gap: 20px;
            z-index: 100;
            transition: background-color var(--transition-speed);
        }

        body.night-mode .feeding-menu {
            background: rgba(42, 42, 62, 0.6);
        }

        .food-item {
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
            opacity: 0.9;
        }

        .food-item:hover {
            transform: scale(1.15);
            opacity: 1;
        }

        .food-projectile {
            position: absolute;
            font-size: 3rem;
            pointer-events: none;
            z-index: 60;
            opacity: 0;
            animation: floatAppear 1.5s ease-in-out forwards;
        }

        @keyframes floatAppear {
            0% {
                transform: translate(-50%, 20px) scale(0.8);
                opacity: 0;
            }

            30% {
                transform: translate(-50%, 0) scale(1);
                opacity: 1;
            }

            70% {
                transform: translate(-50%, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -10px) scale(1.1);
                opacity: 0;
            }
        }

        .theme-toggle {
            position: absolute;
            top: 30px;
            right: 30px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            z-index: 101;
        }

        .theme-toggle:hover {
            opacity: 1;
        }

        /* Stars */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0;
            transition: opacity 1s ease;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 130px 80px, #fff, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 160px 120px, #ddd, rgba(0, 0, 0, 0));
            background-repeat: repeat;
            background-size: 200px 200px;
        }

        body.night-mode .stars {
            opacity: 1;
        }

        /* Clouds */
        .clouds-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
            opacity: 1;
            transition: opacity 1s ease;
        }

        body.night-mode .clouds-container {
            opacity: 0;
        }

        /* Meadow */
        .meadow {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 25vh;
            /* Takes up bottom 25% */
            background: linear-gradient(to top, rgba(143, 188, 143, 0.4), transparent);
            z-index: -1;
            pointer-events: none;
            transition: opacity 1s ease;
            border-radius: 50% 50% 0 0 / 20% 20% 0 0;
            /* Subtle curve */
            transform: scaleX(1.5);
            /* Stretch curve */
        }

        body.night-mode .meadow {
            opacity: 0.1;
            /* Faintly visible or fully hidden */
        }

        .cloud {
            position: absolute;
            background: #fff;
            border-radius: 50px;
            opacity: 0.9;
            /* Increased opacity */
            filter: blur(4px);
            /* Reduced blur */
            animation: drift linear infinite;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
            /* Added shadow */
        }

        .cloud::after,
        .cloud::before {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: 50%;
        }

        .cloud::after {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 25px;
        }

        .cloud::before {
            width: 40px;
            height: 40px;
            top: -15px;
            left: 60px;
        }

        @keyframes drift {
            from {
                transform: translateX(-200px);
            }

            to {
                transform: translateX(100vw);
            }
        }

        @media (max-width: 600px) {
            .bundle {
                width: 40px;
                height: 40px;
            }

            .stick {
                width: 5px;
            }

            h1 {
                font-size: 2rem;
            }
        }

        /* Mini-Game UI */
        #game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(253, 252, 245, 0.9);
            /* Light overlay */
            z-index: 200;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.night-mode #game-overlay {
            background: rgba(26, 26, 46, 0.95);
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Let clicks pass through if needed, but we track mouse */
        }

        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            color: var(--bamboo-shadow);
            z-index: 210;
            pointer-events: none;
        }

        .game-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            z-index: 210;
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .game-close:hover {
            opacity: 1;
        }

        #game-player {
            position: absolute;
            width: 120px;
            /* Doubled from 60px */
            height: 120px;
            /* Doubled from 60px */
            background-image: url('capybara_basket.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            bottom: 20px;
            /* Initial position */
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 210;
        }

        .game-item {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            z-index: 205;
        }

        /* Detailed Scoreboard */
        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            font-family: 'Outfit', sans-serif;
            color: var(--bamboo-shadow);
            z-index: 210;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .score-total {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .score-grid {
            display: flex;
            gap: 15px;
            font-size: 1.4rem;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .play-button {
            position: fixed;
            top: 30px;
            left: 30px;
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.6;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 101;
        }

        .play-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .notes-button {
            position: fixed;
            top: 30px;
            left: 80px;
            /* Right next to play button */
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.6;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 101;
        }

        .notes-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Notes Overlay */
        #notes-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(253, 252, 245, 0.95);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body.night-mode #notes-overlay {
            background: rgba(26, 26, 46, 0.95);
        }

        .notes-container {
            width: 90%;
            max-width: 500px;
            height: 80vh;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .notes-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.3);
        }

        .notes-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .notes-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .notes-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .note-message {
            background: rgba(255, 255, 255, 0.6);
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            align-self: flex-start;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.3s ease;
        }

        .note-message.my-message {
            align-self: flex-end;
            background: #E6A57E;
            color: white;
        }

        body.night-mode .note-message {
            background: rgba(60, 60, 80, 0.6);
            color: #eee;
        }

        body.night-mode .note-message.my-message {
            background: #8FBC8F;
            /* Bamboo color for night/user */
        }

        .note-text {
            font-size: 1rem;
            word-wrap: break-word;
        }

        .note-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }

        .notes-input-area {
            padding: 15px;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            gap: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        #noteInput {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            outline: none;
            font-family: inherit;
        }

        #sendNote {
            background: var(--bamboo-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #sendNote:hover {
            transform: scale(1.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Player (Capybara in Game) */
        #game-player {
            position: absolute;
            bottom: 20px;
            width: 100px;
            pointer-events: none;
            z-index: 204;
        }
    </style>
</head>

<body>

    <!-- Intro Overlay -->
    <div id="intro-overlay"></div>
    <div class="stars"></div>
    <div class="clouds-container" id="cloudsContainer"></div>
    <div class="meadow"></div>
    <!-- Version footer removed per user request -->
    <button class="theme-toggle" id="themeToggle" title="Cambiar tema">üåô</button>
    <button class="play-button" id="playButton" title="Jugar: La Cesta de Regalos">üéÆ</button>

    <!-- Game Overlay -->
    <div id="game-overlay">
        <div class="game-ui">
            <div class="score-total">Puntos: <span id="score">0</span></div>
            <div class="score-grid" id="scoreDetails">
                <!-- Dynamically populated -->
            </div>
        </div>
        <button class="game-close" id="closeGame">‚úï</button>
        <div id="game-player"></div>
        <!-- Items will be spawned here -->
    </div>

    <!-- Feeding Menu -->
    <div class="feeding-menu">
        <div class="food-item" onclick="feedCapybara('üçä')">üçä</div>
        <div class="food-item" onclick="feedCapybara('üçâ')">üçâ</div>
        <div class="food-item" onclick="feedCapybara('üåø')">üåø</div>
        <div class="food-item" onclick="feedCapybara('üçé')">üçé</div>
    </div>

    <h1>Cuenta Regresiva Capibara</h1>
    <!-- Subtitle removed -->

    <div class="capybara-container">
        <img src="capybara.png" alt="Capibara Zen" class="capybara-img" id="capyImage">
    </div>

    <!-- Message of the Day -->
    <div class="message-box" id="dailyMessage">
        ...
    </div>

    <div class="counter-container" id="counter">
        <!-- Bundles generated here -->
    </div>

    <!-- Days text removed -->

    <!-- Hidden Time Travel for User Testing -->
    <details class="debug-panel">
        <summary>‚öôÔ∏è Viaje en el Tiempo (Debug)</summary>
        <div class="slider-container">
            <label for="timeTravel">Desliza para cambiar el d√≠a:</label>
            <input type="range" id="timeTravel" min="0" max="60" step="1" value="0">
            <span id="debugDate">Fecha simulada: Hoy</span>
        </div>
    </details>

    <!-- Notes Button -->
    <button class="notes-button" id="notesButton" title="Dedicato: Notas Compartidas">üìí</button>

    <!-- Notes Overlay -->
    <div id="notes-overlay">
        <div class="notes-container">
            <div class="notes-header">
                <h2>üìí Diario Compartido</h2>
                <button class="notes-close" id="closeNotes">‚úï</button>
            </div>
            <div class="notes-messages" id="notesList">
                <!-- Notes will appear here -->
            </div>
            <div class="notes-input-area">
                <input type="text" id="noteInput" placeholder="Escribe algo bonito..." autocomplete="off">
                <button id="sendNote">‚û§</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Version 8 Compat for simplicity in vanilla HTML) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- FIREBASE CONFIGURATION ---
        // ‚ö†Ô∏è IMPORTANTE: Pega aqu√≠ abajo el c√≥digo que te dio Firebase
        // Reemplaza todo el objeto firebaseConfig con el tuyo.
        const firebaseConfig = {
            apiKey: "AIzaSyCHsBs2yjkX290sxePbpz8ub5KiEV482Xk",
            authDomain: "capicountdown.firebaseapp.com",
            databaseURL: "https://capicountdown-default-rtdb.firebaseio.com",
            projectId: "capicountdown",
            storageBucket: "capicountdown.firebasestorage.app",
            messagingSenderId: "400786374644",
            appId: "1:400786374644:web:02cd7a3fc4ee3478bdc3a1",
            measurementId: "G-9G94HV5RZV"
        };
        // -----------------------------

        // Initialize Firebase safely
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase inicializado");
        } catch (e) {
            console.error("Error inicializando Firebase (¬øFalta la config?):", e);
        }

        const notesBtn = document.getElementById('notesButton');
        const notesOverlay = document.getElementById('notes-overlay');
        const closeNotesBtn = document.getElementById('closeNotes');
        const noteInput = document.getElementById('noteInput');
        const sendNoteBtn = document.getElementById('sendNote');
        const notesList = document.getElementById('notesList');

        // Toggle UI
        notesBtn.addEventListener('click', () => {
            notesOverlay.style.display = 'flex';
            void notesOverlay.offsetWidth;
            notesOverlay.style.opacity = '1';
            scrollToBottom();
        });

        closeNotesBtn.addEventListener('click', () => {
            notesOverlay.style.opacity = '0';
            setTimeout(() => {
                notesOverlay.style.display = 'none';
            }, 300);
        });


        // Send Note
        function sendNote() {
            const text = noteInput.value.trim();
            if (!text) return;
            if (!database) {
                alert("Error cr√≠tico: Firebase no se inici√≥. Revisa la consola.");
                return;
            }

            // Create a unique ID for the user
            let userId = localStorage.getItem('capi_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('capi_user_id', userId);
            }

            const message = {
                text: text,
                timestamp: Date.now(),
                userId: userId
            };

            // Push to Firebase with Error Handling
            const promise = database.ref('shared_notes').push(message);

            promise.then(() => {
                console.log("Nota enviada correctamente");
                noteInput.value = '';
            }).catch((error) => {
                alert("‚ùå Error al guardar: " + error.message);
                console.error("Firebase write error:", error);
            });
        }

        sendNoteBtn.addEventListener('click', sendNote);
        noteInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendNote();
        });
        // Listen for Notes
        if (database) {
            const notesRef = database.ref('shared_notes');

            // On load, handle "Empty State"
            notesRef.once('value').then(snapshot => {
                // Only show empty message if no notes exist
                if (!snapshot.exists()) {
                    notesList.innerHTML = '<div class="note-message system-message">Escribe la primera nota... ‚ú®</div>';
                }
            }).catch(e => {
                notesList.innerHTML = '<div class="note-message system-message" style="color:red">Error de conexi√≥n: ' + e.message + '</div>';
            });

            notesRef.limitToLast(50).on('child_added', (snapshot) => {
                const data = snapshot.val();
                renderMessage(data);
                scrollToBottom();
            }, (error) => {
                console.error("Firebase read error:", error);
                alert("‚ùå Error leyendo notas: " + error.message);
            });
        }

        function scrollToBottom() {
            notesList.scrollTop = notesList.scrollHeight;
        }

        function renderMessage(data) {
            const el = document.createElement('div');
            el.className = 'note-message';

            // Check if it's me
            const myId = localStorage.getItem('capi_user_id');
            if (data.userId === myId) {
                el.classList.add('my-message');
            }

            // Format time
            const date = new Date(data.timestamp);
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            el.innerHTML = `
                <div class="note-text">${escapeHtml(data.text)}</div>
            `;

            // Remove "System Message" if it exists
            const sysMsg = notesList.querySelector('.system-message');
            if (sysMsg) sysMsg.remove();

            notesList.appendChild(el);
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Configuration
        const targetDate = new Date('2026-01-28T00:00:00');
        const images = [
            'capybara.png',          // Relaxed
            'capybara_eating.png',   // Eating
            'capybara_sleeping.png', // Sleeping
            'capybara_onsen.png',    // Onsen
            'capybara_reading.png',  // Reading
            'capybara_music.png',    // Music
            'capybara_cooking.png'   // Cooking
        ];

        const zenMessages = [
            "Ya falta menos que ayer.",
            "El tiempo avanza, quieras o no.",
            "Todo llega a su debido tiempo.",
            "Un d√≠a m√°s, un d√≠a menos.",
            "La espera es parte del proceso.",
            "El 28 se acerca sin prisa pero sin pausa.",
            "Guardando energ√≠a para el gran d√≠a.",
            "Paciencia: el arte de dejar que el tiempo pase.",
            "Solo es cuesti√≥n de tiempo.",
            "El calendario no se detiene.",
            "Lo bueno se hace esperar.",
            "Cada segundo cuenta.",
            "Respira, ya casi estamos.",
            "La meta est√° m√°s cerca.",
            "Disfruta el camino.",
            "Hoy es un paso m√°s.",
            "La paciencia es amarga, pero su fruto es dulce.",
            "No cuentes los d√≠as, haz que los d√≠as cuenten.",
            "Todo llega para quien sabe esperar.",
            "Conf√≠a en el tiempo.",
            "Un d√≠a a la vez.",
            "La calma antes de la celebraci√≥n.",
            "Preparando motores...",
            "Siente la brisa de la espera.",
            "Mant√©n la visi√≥n en el 28.",
            "Peque√±os pasos, grandes distancias.",
            "La espera construye el car√°cter.",
            "Ya casi puedes saborearlo.",
            "Tranquilidad y buenos alimentos.",
            "El futuro se construye hoy.",
            "Nada es eterno, ni siquiera la espera.",
            "Sonr√≠e, el tiempo est√° de tu lado.",
            "La mejor compa√±√≠a es la calma.",
            "Observa c√≥mo pasan las nubes.",
            "El 28 brillar√° m√°s que nunca."
        ];

        // Intro Animation Logic
        function playIntro() {
            const overlay = document.getElementById('intro-overlay');
            const colors = ['#8FBC8F', '#E6A57E', '#556B2F', '#A2D5A2'];

            // Generate leaves
            for (let i = 0; i < 30; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.style.left = Math.random() * 100 + 'vw';
                leaf.style.animationDuration = (Math.random() * 2 + 2) + 's'; // 2-4s
                leaf.style.animationDelay = (Math.random() * 1) + 's';
                leaf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                leaf.style.transform = `scale(${Math.random() * 0.5 + 0.5})`; // Random size
                overlay.appendChild(leaf);
            }

            // Fade out overlay after animation starts finishing
            setTimeout(() => {
                overlay.style.opacity = '0';
            }, 2500);
        }

        // Petting Interaction Logic
        function setupPetting() {
            const capy = document.getElementById('capyImage');
            const container = document.querySelector('.capybara-container');

            capy.addEventListener('click', (e) => {
                // 1. Wiggle Animation
                capy.classList.remove('petting');
                void capy.offsetWidth; // Trigger reflow
                capy.classList.add('petting');

                // 2. Spawn Hearts
                const hearts = ['‚ù§Ô∏è', 'üíñ', 'üíó', 'üíï'];
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerText = hearts[Math.floor(Math.random() * hearts.length)];

                // Position heart near click, but relative to container
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                heart.style.left = (x - 10) + 'px'; // Center
                heart.style.top = (y - 20) + 'px';

                container.appendChild(heart);

                // Cleanup heart
                setTimeout(() => {
                    heart.remove();
                }, 1000);
            });
        }

        // State
        let currentSimulatedDate = new Date();
        let previousDaysLeft = -1;

        function getDaysLeft(baseDate) {
            const today = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
            const target = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            const diffTime = target - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        function updateCapybaraMood(daysLeft) {
            const imgElement = document.getElementById('capyImage');
            const msgElement = document.getElementById('dailyMessage');

            // Cycle logic: Use daysLeft to pick an image index
            // We use daysLeft so it's consistent for everyone on that specific day
            const index = daysLeft % images.length;
            const msgIndex = daysLeft % zenMessages.length;

            // Fade out, swap, fade in
            imgElement.style.opacity = '0';
            msgElement.style.opacity = '0';

            setTimeout(() => {
                imgElement.src = images[index];
                msgElement.innerText = zenMessages[msgIndex];

                imgElement.style.opacity = '1';
                msgElement.style.opacity = '1';
            }, 300);
        }

        function renderTally(days, animateRemoval = false) {
            const container = document.getElementById('counter');

            // Simplified "Visual" Trick:
            // Just render the new state. The user sees the count drop.
            // To make it cooler, let's try to render the "falling" stick.

            container.innerHTML = '';

            const bundles = Math.floor(days / 5);
            const remainder = days % 5;

            // Render full bundles
            for (let i = 0; i < bundles; i++) {
                createBundle(5, true, container);
            }

            // Render remainder
            if (remainder > 0) {
                createBundle(remainder, false, container);
            }

            // If we want to show a falling stick (the one that just vanished)
            if (animateRemoval) {
                const fallingStick = document.createElement('div');
                fallingStick.className = 'stick falling';
                fallingStick.style.height = '60px'; // Approximate bundle height
                fallingStick.style.width = '8px';
                fallingStick.style.marginLeft = '10px';
                container.appendChild(fallingStick);
            }

            // document.getElementById('daysText').innerText = `Faltan ${days} d√≠as`;
        }

        function createBundle(count, isCompleted, parent) {
            const bundle = document.createElement('div');
            bundle.className = 'bundle';
            if (isCompleted) bundle.classList.add('completed');

            const verticalCount = isCompleted ? 4 : count;

            for (let i = 0; i < 4; i++) {
                const stick = document.createElement('div');
                stick.className = 'stick';
                if (i >= verticalCount) {
                    stick.style.opacity = '0';
                }
                bundle.appendChild(stick);
            }

            if (isCompleted) {
                const diagonal = document.createElement('div');
                diagonal.className = 'stick diagonal';
                bundle.appendChild(diagonal);

                const yuzu = document.createElement('div');
                yuzu.className = 'yuzu';
                bundle.appendChild(yuzu);
            }

            parent.appendChild(bundle);
        }

        // --- Logic & Events ---

        function updateAll(date) {
            const days = getDaysLeft(date);

            // Detect if we should animate (only if days decreased by 1)
            const shouldAnimate = (previousDaysLeft !== -1 && days < previousDaysLeft);

            renderTally(days, shouldAnimate);
            updateCapybaraMood(days);

            previousDaysLeft = days;

            // Update debug text
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('debugDate').innerText = "Fecha simulada: " + date.toLocaleDateString('es-ES', options);
        }

        // Initialize
        const now = new Date();
        updateAll(now);
        playIntro(); // Play intro on load
        setupPetting(); // Enable petting
        generateClouds(); // Generate clouds

        function generateClouds() {
            const container = document.getElementById('cloudsContainer');
            const cloudCount = 6;

            for (let i = 0; i < cloudCount; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';

                // Randomize size
                const width = 100 + Math.random() * 150;
                const height = 40 + Math.random() * 40;
                cloud.style.width = width + 'px';
                cloud.style.height = height + 'px';

                // Randomize position
                cloud.style.top = (Math.random() * 40) + '%'; // Top 40% of screen (Higher up)

                // Randomize animation
                const duration = 60 + Math.random() * 60; // 60-120s
                const delay = Math.random() * -120; // Start at random point in animation
                cloud.style.animationDuration = duration + 's';
                cloud.style.animationDelay = delay + 's';

                // Randomize opacity
                cloud.style.opacity = 0.7 + Math.random() * 0.3; // Increased opacity

                container.appendChild(cloud);
            }
        }

        // Time Travel Slider Logic
        const slider = document.getElementById('timeTravel');
        const maxDays = getDaysLeft(now); // Set slider max to current days left (so we can go back to 0)
        slider.max = maxDays + 10; // Give some buffer
        slider.value = 0; // 0 means "add 0 days to today", actually we want to subtract? 
        // Let's make the slider represent "Days Passed from Today".

        slider.addEventListener('input', (e) => {
            const daysPassed = parseInt(e.target.value);
            const simulatedDate = new Date();
            simulatedDate.setDate(simulatedDate.getDate() + daysPassed);
            updateAll(simulatedDate);
        });


        // Debug Panel Visibility Logic
        function checkDebugMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const debugPanel = document.querySelector('.debug-panel');

            // 1. Check URL parameter ?debug=true
            if (urlParams.get('debug') === 'true') {
                debugPanel.style.display = 'block';
            }

            // 2. Secret Key Sequence: type 'dev'
            let keySequence = '';
            window.addEventListener('keydown', (e) => {
                keySequence += e.key;
                if (keySequence.length > 3) {
                    keySequence = keySequence.slice(-3);
                }
                if (keySequence === 'dev') {
                    debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
                    // Clear sequence to prevent double toggling
                    keySequence = '';
                }
            });
        }
        checkDebugMode();

        // Night Mode Logic
        const themeToggle = document.getElementById('themeToggle');
        const bodyTheme = document.body;

        themeToggle.addEventListener('click', () => {
            bodyTheme.classList.toggle('night-mode');
            const isNight = bodyTheme.classList.contains('night-mode');
            themeToggle.innerText = isNight ? '‚òÄÔ∏è' : 'üåô';

            // Optional: Switch Capybara to sleeping if night mode is on
            // But only if we want to override the daily mood. 
            // Let's keep it simple for now and just change the atmosphere.
        });

        // Feeding Logic
        function feedCapybara(foodEmoji) {
            const capy = document.getElementById('capyImage');
            const container = document.querySelector('.capybara-container');

            // Create "offering"
            const offering = document.createElement('div');
            offering.innerText = foodEmoji;
            offering.className = 'food-projectile'; // Reusing class name but with new CSS

            // Position in center of container, slightly lower
            offering.style.left = '50%';
            offering.style.bottom = '20px';

            container.appendChild(offering);

            // Wait for animation to finish (1.5s total, but we trigger reaction a bit earlier for flow)
            setTimeout(() => {
                // Reaction: Happy Bounce
                capy.classList.remove('happy-bounce');
                void capy.offsetWidth; // Trigger reflow
                capy.classList.add('happy-bounce');

                // Reaction: Text Bubble
                const phrases = ['¬°√ëam!', '¬°Rico!', '¬°Gracias!', 'üòã', 'üçä'];
                const text = phrases[Math.floor(Math.random() * phrases.length)];

                const bubble = document.createElement('div');
                bubble.className = 'text-bubble';
                bubble.innerText = text;

                // Position relative to container
                bubble.style.left = '50%';
                bubble.style.top = '10%';
                bubble.style.transform = 'translateX(-50%) translateY(10px)';

                container.appendChild(bubble);

                // Animate in
                requestAnimationFrame(() => {
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'translateX(-50%) translateY(0)';
                });

                // Remove after 1.5s
                setTimeout(() => {
                    bubble.style.opacity = '0';
                    bubble.style.transform = 'translateX(-50%) translateY(-10px)';
                    setTimeout(() => bubble.remove(), 300);
                }, 1500);

                // Spawn hearts
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const heart = document.createElement('div');
                        heart.className = 'heart';
                        heart.innerText = 'üòã';

                        // Center in container
                        const containerRect = container.getBoundingClientRect();
                        heart.style.left = (containerRect.width / 2 - 10 + (Math.random() * 40 - 20)) + 'px';
                        heart.style.top = (containerRect.height / 2 - 50) + 'px';
                        container.appendChild(heart);

                        setTimeout(() => heart.remove(), 1000);
                    }, i * 200);
                }

            }, 1200); // Trigger reaction just before food fades out completely

            // Cleanup offering
            setTimeout(() => {
                offering.remove();
            }, 1500);
        }

        // --- Mini-Game Logic: La Cesta de Regalos ---
        const playBtn = document.getElementById('playButton');
        const gameOverlay = document.getElementById('game-overlay');
        const closeGameBtn = document.getElementById('closeGame');
        const player = document.getElementById('game-player');
        // scoreDisplay defined in updateScoreboard

        let gameActive = false;
        let score = 0;
        let itemCounts = {};
        let gameLoopId;
        let spawnIntervalId;
        let items = [];
        let mouseX = window.innerWidth / 2;

        // Open Game
        playBtn.addEventListener('click', () => {
            gameOverlay.style.display = 'flex';
            void gameOverlay.offsetWidth;
            gameOverlay.style.opacity = '1';
            startGame();
        });

        // Close Game
        closeGameBtn.addEventListener('click', () => {
            gameOverlay.style.opacity = '0';
            setTimeout(() => {
                gameOverlay.style.display = 'none';
                stopGame();
            }, 500);
        });

        // Player Movement (Mouse/Touch)
        window.addEventListener('mousemove', (e) => {
            if (!gameActive) return;
            mouseX = e.clientX;
            updatePlayerPosition();
        });

        window.addEventListener('touchmove', (e) => {
            if (!gameActive) return;
            mouseX = e.touches[0].clientX;
            updatePlayerPosition();
        });

        function updatePlayerPosition() {
            // Clamp to screen
            const x = Math.max(60, Math.min(window.innerWidth - 60, mouseX));
            player.style.left = x + 'px';
        }

        function startGame() {
            gameActive = true;
            score = 0;
            itemCounts = {}; // Reset counts
            updateScoreboard();
            items = [];

            // Clear existing items
            document.querySelectorAll('.game-item').forEach(el => el.remove());

            // Start Loops
            spawnIntervalId = setInterval(spawnItem, 1000);
            gameLoop();
        }

        function stopGame() {
            gameActive = false;
            clearInterval(spawnIntervalId);
            cancelAnimationFrame(gameLoopId);
        }

        function updateScoreboard() {
            document.getElementById('score').innerText = score;

            const detailsContainer = document.getElementById('scoreDetails');
            detailsContainer.innerHTML = '';

            // Render counts for each item type
            for (const [emoji, count] of Object.entries(itemCounts)) {
                if (count > 0) {
                    const badge = document.createElement('div');
                    badge.innerText = `${emoji} ${count}`;
                    detailsContainer.appendChild(badge);
                }
            }
        }

        function spawnItem() {
            if (!gameActive) return;

            const types = [
                { text: 'üçé', score: 10, speed: 2, type: 'fruit' },
                { text: 'üçä', score: 10, speed: 2.5, type: 'fruit' },
                { text: 'üçâ', score: 10, speed: 3, type: 'fruit' },
                { text: 'üå∏', score: 20, speed: 1.5, type: 'rare' },
                { text: '‚≠êÔ∏è', score: 50, speed: 3.5, type: 'rare' },
                { text: 'üçÇ', score: 100, speed: 1, type: 'leaf' } // High score!
            ];

            const randomType = types[Math.floor(Math.random() * types.length)];
            const item = document.createElement('div');
            item.className = 'game-item';
            item.innerText = randomType.text;

            // Random X start
            const startX = Math.random() * (window.innerWidth - 60);
            item.style.left = startX + 'px';
            item.style.top = '-50px';

            gameOverlay.appendChild(item);

            items.push({
                element: item,
                x: startX,
                y: -50,
                speed: randomType.speed,
                type: randomType.type,
                score: randomType.score,
                text: randomType.text,
                wobble: Math.random() * Math.PI * 2
            });
        }

        function gameLoop() {
            if (!gameActive) return;

            // Update items
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];

                // Move down
                item.y += item.speed;

                // Wobble for leaves
                if (item.type === 'leaf') {
                    item.x += Math.sin(item.y / 50 + item.wobble) * 1.5; // Gentle sway
                }

                item.element.style.top = item.y + 'px';
                item.element.style.left = item.x + 'px';

                // Collision Detection
                const playerRect = player.getBoundingClientRect();
                const itemRect = item.element.getBoundingClientRect();

                // Player is bigger now (120px), adjust hitbox slightly
                // Hitbox: center 60% of width/height for fairness
                const hitMarginX = playerRect.width * 0.2;
                const hitMarginY = playerRect.height * 0.2;

                if (
                    itemRect.bottom >= playerRect.top + hitMarginY &&
                    itemRect.top <= playerRect.bottom - hitMarginY &&
                    itemRect.right >= playerRect.left + hitMarginX &&
                    itemRect.left <= playerRect.right - hitMarginX
                ) {
                    // Collision!
                    score += item.score;

                    // Update count
                    itemCounts[item.text] = (itemCounts[item.text] || 0) + 1;

                    updateScoreboard();
                    showFeedback(item.x, item.y, '+' + item.score);

                    // Remove item
                    item.element.remove();
                    items.splice(i, 1);
                    continue;
                }

                // Remove if off screen
                if (item.y > window.innerHeight) {
                    item.element.remove();
                    items.splice(i, 1);
                }
            }

            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function showFeedback(x, y, text) {
            const feedback = document.createElement('div');
            feedback.style.position = 'absolute';
            feedback.style.left = x + 'px';
            feedback.style.top = y + 'px';
            feedback.style.color = '#E6A57E';
            feedback.style.fontWeight = 'bold';
            feedback.style.fontSize = '1.2rem';
            feedback.style.pointerEvents = 'none';
            feedback.innerText = text;
            feedback.style.zIndex = 220;

            // Animate up
            feedback.animate([
                { transform: 'translateY(0)', opacity: 1 },
                { transform: 'translateY(-30px)', opacity: 0 }
            ], {
                duration: 800,
                easing: 'ease-out'
            });

            gameOverlay.appendChild(feedback);
            setTimeout(() => feedback.remove(), 800);
        }

    </script>
</body>

</html>